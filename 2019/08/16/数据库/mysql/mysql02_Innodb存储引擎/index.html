<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="体系架构">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql02_Innodb存储引擎">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;08&#x2F;16&#x2F;%E6%95%B0%E6%8D%AE%E5%BA%93&#x2F;mysql&#x2F;mysql02_Innodb%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E&#x2F;index.html">
<meta property="og:site_name" content="Chenaa&#39;s Notes">
<meta property="og:description" content="体系架构">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_02_01.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_02_02.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_02_03.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_02_04.png">
<meta property="og:updated_time" content="2020-06-04T00:32:08.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_02_01.png">

<link rel="canonical" href="http://yoursite.com/2019/08/16/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql02_Innodb%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>mysql02_Innodb存储引擎 | Chenaa's Notes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chenaa's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">尘事如潮人如水</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/16/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql02_Innodb%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="chenaa">
      <meta itemprop="description" content="zZ..zZ..">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenaa's Notes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql02_Innodb存储引擎
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-16 20:30:00" itemprop="dateCreated datePublished" datetime="2019-08-16T20:30:00+08:00">2019-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-04 08:32:08" itemprop="dateModified" datetime="2020-06-04T08:32:08+08:00">2020-06-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="体系架构"><a href="#体系架构" class="headerlink" title="体系架构"></a>体系架构</h1><p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_02_01.png" alt=""></p>
<a id="more"></a>

<h2 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h2><ol>
<li><strong>Master Thread</strong> 主要负责将缓冲池中的数据异步刷新<br>到磁盘,保证数据的一致性,包括脏页的刷新、合并插人缓冲( INSERT BUFFER)、UNDO页的回收等。</li>
<li><strong>IO Thread</strong> 在 InnoDB存储引擎中大量使用了AIO( Async IO)来处理写IO请求,这样可以极大提高数据库的性能。而 IO Thread的工作主要是负责这些IO请求的回调( call back)处理。 </li>
<li><strong>Purge Thread</strong> 事务被提交后,其所使用的 undolog可能不再需要,因此需要 PurgeThread来回收已经使用并分配的undo页。</li>
<li><strong>Page Cleaner Thread</strong> 在 InnoDB12x版本中引入的。其作用是将之前版本中<strong>脏页的刷新操作</strong>都放入到单独的线程中来完成。而其目的是为了减轻原 Master Thread的工作及对于用户査询线程的阻塞,进一步提高 InnoDB存储引擎的性能</li>
</ol>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><h3 id="缓冲池"><a href="#缓冲池" class="headerlink" title="缓冲池"></a>缓冲池</h3><p>InnoDB存储引擎是基于磁盘存储的,并将其中的记录按照页的方式进行管理。</p>
<p>基于磁盘的数据库系统通常使用缓冲池技术来提高数据库的整体性能。</p>
<p>在数据库中进行读取页的操作,首先将从磁盘读到的页存放在缓冲池中,<br>这个过程称为将页“FIX”在缓冲池中。下一次再读相同的页时,首先判断该页是否在缓冲池中。若在缓冲池中,称该页在缓冲池中被命中,直接读取该页。否则,读取磁盘上的页。</p>
<p>对于数据库中页的修改操作,则首先修改在缓冲池中的页,然后再以一定的频率刷新到磁盘上。<strong>页从缓冲池刷新回磁盘的操作并不是在每次页发生更时触发，而是通过checkPoint机制刷新回磁盘</strong></p>
<p>缓冲池中缓存的数据页类型有:索引页、数据页、undo页、插入缓冲、自适应哈希索引、 InnoDB存储的锁信息、数据字典信息等。</p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_02_02.png" alt=""></p>
<h3 id="LRU-List、Free-List和Flush-List"><a href="#LRU-List、Free-List和Flush-List" class="headerlink" title="LRU List、Free List和Flush List"></a>LRU List、Free List和Flush List</h3><p>在 InnoDB存储引擎中,缓冲池中页的大小默认为16KB,数据库中的缓冲池是通过LRU算法来进行管理的。即最频繁使用的页在LRU列表的前端,而最少使用的页在LRU列表的尾端。当缓冲池不能存放新读取到的页时,将首先释放LRU列表中尾端的页。</p>
<p><strong>innnodb的LRU优化</strong></p>
<p>InnoDB的存储引擎中,LRU列表中还加入了midpoint位置。新读取到的页,虽然是最新访问的页,但并不是直接放入到LRU列表的首部,而是放入到LRU列表的 midpoint位置。在默认配置下,该位置在LRU列表长度的5/8处</p>
<p><strong>为什么不用朴素LRU</strong></p>
<p>LRU是热点数据在链表前部，如果一次在lru里面添加大量的页，大量数据往LRU的前部插入，把原来的热点数据冲到链表外面，导致下次需要从磁盘读取。</p>
<p>在LRU列表中的页被修改后,称该页为脏页( dirty page),即缓冲池中的页和磁盘上的页的数据产生了不一致。这时数据库会通过 CHECKPOINT机制将脏页刷新回磁盘,而 Flush List中的页即为脏页列表。需要注意的是,脏页既存在于LRU列表中,也存在于Fush列表中。LRU列表用来管理缓冲池中页的可用性, Flush列表用来管理将页刷新回磁盘,二者互不影响。</p>
<h3 id="redo-log-buffer"><a href="#redo-log-buffer" class="headerlink" title="redo log buffer"></a>redo log buffer</h3><p> InnoDB存储引擎首先将重做日志信息先放入到这个缓冲区,然后按一定频率将其刷新到重做日志文件。</p>
<p> 下列三种情况下会将重做日志缓冲中的内容刷新到外部磁盘的重做日志文件中：</p>
<ol>
<li>Master Thread每一秒将重做日志缓冲刷新到重做日志文件</li>
<li>每个事务提交时会将重做日志缓冲刷新到重做日志文件;</li>
<li>当重做日志缓冲池剩余空间小于1/2时,重做日志缓冲刷新到重做日志文件。</li>
</ol>
<h2 id="缓存池设计目标"><a href="#缓存池设计目标" class="headerlink" title="缓存池设计目标"></a>缓存池设计目标</h2><p>缓冲池的设计目的为了协调CPU速度与磁盘速度的鸿沟。因此页的操作首先都是在缓冲池中完成的。如果一条DML语句,如 Update或 Delete改变了页中的记录,那么此时页是脏的,即缓冲池中的页的版本要比磁盘的新。</p>
<p><strong>数据库需要将新版本的页从缓冲池刷新到磁盘。</strong></p>
<p>倘若每次一个页发生变化,就将新页的版本刷新到磁盘,那么这个开销是非常大的。若热点数据集中在某几个页中,那么数据库的性能将变得非常差。同时,如果在从缓冲池将页的新版本刷新到磁盘时发生了宕机,那么数据就不能恢复了。</p>
<p>为了避免发生数据丢失的问题,当前事务数据库系统普遍都采用了 <strong>Write Ahead log策略</strong>,即<strong>当事务提交时,先写重做日志,再修改页。</strong>当由于发生宕机而导致数据丢失时,通过重做日志来完成数据的恢复。</p>
<h1 id="Checkpoint"><a href="#Checkpoint" class="headerlink" title="Checkpoint"></a>Checkpoint</h1><p>Checkpoint(检查点)技术的目的是解决以下几个问题</p>
<ol>
<li><p>缩短数据库的恢复时间;</p>
<blockquote>
<p>当数据库发生宕机时,数据库不需要重做所有的日志,因为 Checkpoint之前的页都已经刷新回磁盘。故数据库只需对 Checkpoint后的重做日志进行恢复。这样就大大缩短了恢复的时间。</p>
</blockquote>
</li>
<li><p>缓冲池不够用时,将脏页刷新到磁盘;</p>
</li>
<li><p>重做日志不可用时,刷新脏页(redo log是重复使用的，写满了以后，需要强制触发checkpoint刷盘)</p>
</li>
</ol>
<p>对于 InnoDB存储引擎而言,其是通过LSN( Log Sequence Number)来标记版本的。而LSN是8字节的数字,其单位是字节。每个页有LSN,重做日志中也有LSN,Checkpoint也有LSN。</p>
<h2 id="checkPoint类型"><a href="#checkPoint类型" class="headerlink" title="checkPoint类型"></a>checkPoint类型</h2><p>在 InnoDB存储引擎内部,有两种 Checkpoint分别为:</p>
<ol>
<li>Sharp Checkpoint 所有脏页都刷盘</li>
<li>Fuzzy Checkpoint 部分脏页刷盘</li>
</ol>
<p>Sharp Checkpoint发生在数据库关闭时将所有的脏页都刷新回磁盘,这是默认的工作</p>
<p>InnoDB存储引擎中可能发生如下几种情况的Fuzzy Checkpoint</p>
<ol>
<li><p>Master Thread Checkpoint</p>
<blockquote>
<p>Master Thread差不多以每秒或每十秒的速度从缓冲池的脏页列表中，<strong>异步</strong>刷新一定比例的页回磁盘。</p>
</blockquote>
</li>
<li><p>FLUSH LRU LIST Checkpoint</p>
<blockquote>
<p>InnoDB存储引擎需要保证LRU列表中需要有100个空闲页可供使用,如果不足100，会将LRU列表尾部的页移除，直到100个空闲页。<strong>检查是否存在100个空闲页的操作，在Page Cleaner线程中进行。</strong></p>
</blockquote>
</li>
<li><p>Async/Sync Flush Checkpoint</p>
<blockquote>
<p>redo log文件不可用的情况(redo log剩余可用空间小于一定阈值),这时需要强制将些页刷新回磁盘,而此时脏页是从脏页列表中选取的。(5.6版本后刷盘操作也在Page Cleaner线程中进行，不会阻塞用户线程)</p>
</blockquote>
</li>
<li><p>Dirty Page too much Checkpoint 脏页数量太多，引擎强制执行checkPoint</p>
</li>
</ol>
<h1 id="Master-Thread-工作方式"><a href="#Master-Thread-工作方式" class="headerlink" title="Master Thread 工作方式"></a>Master Thread 工作方式</h1><p>Master Thread具有最高的线程优先级别。其内部由多个循环(loo)组成:主循环(loop)、后台循环( backgroup loop)、刷新循环( fush loop)、暂停循环( suspend loop) 。Master Thread会根据数据库运行的状态在loop、 background loop、 flush loop和 suspendl oop中进行切换。</p>
<p>Loop被称为主循环,因为大多数的操作是在这个循环中,其中有两大部分的操<br>作——每秒钟的操作和每10秒的操作。伪代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">master_thread</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; <span class="number">1</span>&lt;<span class="number">10</span>; <span class="number">1</span>++)&#123;</span><br><span class="line">		<span class="keyword">do</span> thing once per second</span><br><span class="line">		sleep <span class="number">1</span> second <span class="keyword">if</span> necessary</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">do</span> things once per ten seconds</span><br><span class="line">	goto loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每秒一次的操作包括:</p>
<ol>
<li>redo log buffer刷新到磁盘(总是);</li>
<li>合并插入缓冲(可能);</li>
<li>至多刷新100个 InnoDB的缓冲池中的脏页到磁盘(引擎根据阈值判断是否需要刷页，现在已放在Page Clear线程中执行);</li>
<li>如果当前没有用户活动,则切换到 background loop(可能)。</li>
</ol>
<p>接着来看每10秒的操作,包括如下内容:</p>
<ol>
<li>刷新100个脏页到磁盘(可能的情况下);</li>
<li>合并至多5个插人缓冲(总是);</li>
<li>将日志缓冲刷新到磁盘(总是);</li>
<li>删除无用的Undo页(总是);</li>
<li>刷新100个或者10个脏页到磁盘(总是)。</li>
</ol>
<p><strong>删除Undo页</strong></p>
<p>InnoDB存储引擎会进行一步执行full purge操作,即删除无用的Undo页。<strong>对表进行 update、 delete这类操作时,原先的行被标记为删除,但是因为一致性<br>读( consistent read)的关系,需要保留这些行版本的信息。</strong>但是在 full purge过程中,InnoDB存储引擎会判断当前事务系统中已被删除的行是否可以删除,比如有时候可能还有查询操作需要读取之前版本的undo信息,如果可以删除, InnoDB会立即将其删除。</p>
<h1 id="关键特性"><a href="#关键特性" class="headerlink" title="关键特性"></a>关键特性</h1><h2 id="insert-buffer-change-buffer"><a href="#insert-buffer-change-buffer" class="headerlink" title="insert buffer(change buffer)"></a>insert buffer(change buffer)</h2><p>在MySQL5.5之前的版本中，由于只支持缓存insert操作，所以最初叫做insert buffer，只是后来的版本中支持了更多的操作类型缓存，才改叫change buffer。</p>
<p><strong>对于非聚集索引的插入或更新操作,不是每一次直接插入到索引页中</strong>,而是先判断插入的非聚集索引页是否在缓冲池中,若在,则直接插入;若不在,则先放人到一个 Insert Buffer对象中,好似欺骗。</p>
<p>数据库这个非聚集的索引已经插到叶子节点,而实际并没有,只是存放在另一个位置。然后再以定的频率和情况进行 Insert Buffer和辅助索引页子节点的 merge(合并)操作,这时通常能将多个插入合并到一个操作中(因为在一个索引页中),这就大大提高了对于非聚集索引插入的性能。</p>
<p>Insert Buffer的使用需要同时满足以下两个条件:</p>
<ol>
<li><p>索引是辅助索引( secondary index);</p>
</li>
<li><p>索引不是唯一( unique)的。</p>
<blockquote>
<p> 辅助索引不能是唯一的,因为在插入缓冲时,数据库并不去查找索引页来判断插入的记录的唯一性。如果去査找肯定又会有离散读取的情况发生,从而导致Insert Buffer失去了意义。</p>
</blockquote>
</li>
</ol>
<h2 id="两次写-double-write"><a href="#两次写-double-write" class="headerlink" title="两次写(double write)"></a>两次写(double write)</h2><p>double write(两次写)带给 InnoDB存储引擎的是数据页的可靠性。</p>
<p>double write由两部分组成,一部分是内存中的 doublewrite buffer,大小为2MB,另部分是物理磁盘上共享表空间中连续的128个页,即2个区( extent),大小同样为2MB。</p>
<p><strong>第一次写</strong></p>
<p>在对缓冲池的脏页进行刷新时,并不直接写磁盘,而是会通过 memcpy函数将<br>脏页先复制到内存中的 double write buffer,之后通过 doublewrite buffer再分两次,每次1MB顺序地写入共享表空间的物理磁盘上,然后马上调用 fsync函数,同步磁盘,避免缓冲写带来的问题。（此时缓存已经持久化到硬盘上了，避免写到一半宕机，页不完整）</p>
<p>在这个过程中,因为 doublewrite页是连续的,因此这个过程是顺序写的,开销并不是很大。</p>
<p><strong>第二次写</strong></p>
<p>在完成 doublewrite页的写入后,再将 doublewrite buffer中的页写入各个表空间文件中,此时的写人则是离散的。</p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_02_03.jpg" alt=""></p>
<h2 id="自适应哈希索引"><a href="#自适应哈希索引" class="headerlink" title="自适应哈希索引"></a>自适应哈希索引</h2><p>InnoDB存储引擎会监控对表上各索引页的查询。如果观察到建立哈希索引可以带来速度提升,则建立哈希索引,称之为自适应哈希索引。</p>
<h1 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h1><h2 id="mysql文件，针对所有引擎"><a href="#mysql文件，针对所有引擎" class="headerlink" title="mysql文件，针对所有引擎"></a>mysql文件，针对所有引擎</h2><ol>
<li>错误日志</li>
<li>慢查询日志</li>
<li>查询日志</li>
<li>bin log</li>
</ol>
<h2 id="bin-log"><a href="#bin-log" class="headerlink" title="bin log"></a>bin log</h2><p><strong>二进制日志( binary log)记录了对 MySQL数据库执行更改的所有操作,但是不包括 SELECT和SHOW这类操作。若操作本身并没有对数据发生变化，该操作也有可能被记录bin log。</strong>(update t set a=1 where a=2 ,没有a=2的记录)</p>
<p>二进制日志主要有以下几种作用</p>
<ol>
<li><strong>恢复(recovery)</strong>:某些数据的恢复需要二进制日志,例如,在一个数据库全备文件恢复后,用户可以通过二进制日志进行 point-in-time的恢复。</li>
<li><strong>复制(replication)</strong>:其原理与恢复类似,通过复制和执行二进制日志使一台远程的 MySQL数据库(一般称为 slave)与一台 MySQL数据库(一般称为 master)进行实时同步。</li>
<li><strong>审计</strong>:用户可以通过二进制日志中的信息来进行审计,判断是否有对数<br>据库进行注入的攻击。</li>
</ol>
<p><strong>bin log 和事务</strong></p>
<p>当使用事务的表存储引擎(如InnoDB存储引擎)时,所有未提交的二进制日志会被记录到一个缓存中去,等该事务提交时直接将缓冲中的二进制日志写入二进制日志文件。</p>
<p>在默认情况下,二进制日志并不是在每次写的时候同步到磁盘。因此,当数据库所在操作系统发生宕机时,可能会有最后一部分数据没有写入二进制日志文件中,这会给恢复和复制带来问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">参数 sync_binlog=[N]表示每写缓冲多少次就同步到磁盘。</span><br><span class="line"></span><br><span class="line">0 ：存储引擎不进行binlog的刷新到磁盘，而由操作系统的文件系统控制缓存刷新。</span><br><span class="line"></span><br><span class="line">1：每提交一次事务，存储引擎调用文件系统的sync操作进行一次缓存的刷新，这种方式最安全，但性能较低。</span><br><span class="line"></span><br><span class="line">n：当提交的日志组=n时，存储引擎调用文件系统的sync操作进行一次缓存的刷新。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sync_binlog的默认值为0，不写binlog。</span><br></pre></td></tr></table></figure>

<p><strong>即使sync_binlog为1，也会有数据一致性问题，见redo log 和bin log区别</strong></p>
<h2 id="InnoDB存储引擎文件"><a href="#InnoDB存储引擎文件" class="headerlink" title="InnoDB存储引擎文件"></a>InnoDB存储引擎文件</h2><h3 id="表空间文件"><a href="#表空间文件" class="headerlink" title="表空间文件"></a>表空间文件</h3><ol>
<li>默认表空间文件（共享表空间）</li>
<li>独立表空间文件 (通过参数开启)</li>
</ol>
<p>每张表的独立表空间内存放的只是数据、索引和插入缓冲 Bitmap页,其他类的数据,如回滚信息,插人缓冲索引页、系统事务信息,二次写缓冲等还是存放在原来的共享表空间内。</p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_02_04.png" alt=""></p>
<h3 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h3><p><strong>redo log记录了InnoDB的事务日志。</strong></p>
<p>每个 InnoDB存储引擎至少有1个redo log文件组( group),每个文件组下至少有个2redo log文件。默认两个，默认大小每个1G。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit:</span><br><span class="line"></span><br><span class="line">0，表示每次事务提交时都只是把redo log留在redo log buffer中;</span><br><span class="line"></span><br><span class="line">1，表示每次事务提交时都将redo log直接持久化到磁盘；</span><br><span class="line"></span><br><span class="line">2,表示每次事务提交时都只是把redo log写到page cache（写到磁盘(write)，但是没有持久化（fsync)，物理上是在文件系统的page cache里面）</span><br></pre></td></tr></table></figure>


<h2 id="redo-log-和-bin-log区别"><a href="#redo-log-和-bin-log区别" class="headerlink" title="redo log 和 bin log区别"></a>redo log 和 bin log区别</h2><ol>
<li><p>作用域不同</p>
<blockquote>
<p>   二进制日志会记录所有与 MYSQL数据库有关的日志记录,包括 InnodB、MyISAM、Heap等其他存储引擎的日志。而 InnoDB存储引擎的重做日志只记录有关该存储引擎本身的事务日志。</p>
</blockquote>
</li>
<li><p>记录的内容不同</p>
<blockquote>
<p>   二进制日志文是逻辑日志。而 InnoDB存储引擎的重做日志文件记录的是关于每个页(Page)的更改的物理情况。</p>
</blockquote>
</li>
<li><p>写入的时间也不同</p>
<blockquote>
<pre><code>二进制日志文件仅在事务提交前进行提交,即只写磁盘一次,不论这时该事务多大。而在事务进行的过程中,却不断有重做日志条目(redo entry)被写入到重做日志文件中。</code></pre></blockquote>
</li>
</ol>
<p><strong>mysql是如何解决redo log 和bin log数据不一致的？</strong></p>
<blockquote>
<p>   将sync_binlog设为1,还是会有一种情况导致问题的发生。</p>
<p>   当使用InnoDB存储引擎时,在一个事务发出COMMIT动作之前,由于sync _binlog为1,因此会将二进制日志立即写入磁盘。如果这时已经写人了二进制日志,但是提交还没有发生（没有记录到redo log）,并且此时发生了宕机,那么在 MySQL数据库下次启动时,由于 COMMIT操作并没有发生,这个事务会被回滚掉。但是二进制日志已经记录了该事务信息,不能被回滚。</p>
<p>   这个问题可以通过将参数 innodb_support_xa设为1来解决,虽然 innodb support xa与XA事务有关,但它同时也确保了二进制日志和 InnoDB存储引擎数据文件的同步。</p>
<p>即 <strong>两阶段提交</strong></p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/08/15/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql01_%E5%9F%BA%E7%A1%80&%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84/" rel="prev" title="mysql01_基础&体系架构">
      <i class="fa fa-chevron-left"></i> mysql01_基础&体系架构
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/08/17/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql03_Innodb%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/" rel="next" title="mysql03_Innodb数据存储结构">
      mysql03_Innodb数据存储结构 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#体系架构"><span class="nav-number">1.</span> <span class="nav-text">体系架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#后台线程"><span class="nav-number">1.1.</span> <span class="nav-text">后台线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内存"><span class="nav-number">1.2.</span> <span class="nav-text">内存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓冲池"><span class="nav-number">1.2.1.</span> <span class="nav-text">缓冲池</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LRU-List、Free-List和Flush-List"><span class="nav-number">1.2.2.</span> <span class="nav-text">LRU List、Free List和Flush List</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log-buffer"><span class="nav-number">1.2.3.</span> <span class="nav-text">redo log buffer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存池设计目标"><span class="nav-number">1.3.</span> <span class="nav-text">缓存池设计目标</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Checkpoint"><span class="nav-number">2.</span> <span class="nav-text">Checkpoint</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#checkPoint类型"><span class="nav-number">2.1.</span> <span class="nav-text">checkPoint类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Master-Thread-工作方式"><span class="nav-number">3.</span> <span class="nav-text">Master Thread 工作方式</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#关键特性"><span class="nav-number">4.</span> <span class="nav-text">关键特性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#insert-buffer-change-buffer"><span class="nav-number">4.1.</span> <span class="nav-text">insert buffer(change buffer)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#两次写-double-write"><span class="nav-number">4.2.</span> <span class="nav-text">两次写(double write)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#自适应哈希索引"><span class="nav-number">4.3.</span> <span class="nav-text">自适应哈希索引</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#文件"><span class="nav-number">5.</span> <span class="nav-text">文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#mysql文件，针对所有引擎"><span class="nav-number">5.1.</span> <span class="nav-text">mysql文件，针对所有引擎</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#bin-log"><span class="nav-number">5.2.</span> <span class="nav-text">bin log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#InnoDB存储引擎文件"><span class="nav-number">5.3.</span> <span class="nav-text">InnoDB存储引擎文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#表空间文件"><span class="nav-number">5.3.1.</span> <span class="nav-text">表空间文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redo-log"><span class="nav-number">5.3.2.</span> <span class="nav-text">redo log</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redo-log-和-bin-log区别"><span class="nav-number">5.4.</span> <span class="nav-text">redo log 和 bin log区别</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="chenaa"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">chenaa</p>
  <div class="site-description" itemprop="description">zZ..zZ..</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenaa</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
