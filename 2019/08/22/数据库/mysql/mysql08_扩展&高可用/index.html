<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Gemini","version":"7.7.1","exturl":false,"sidebar":{"position":"left","display":"post","offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="扩展mysql什么时候可扩展性？ 简要地说,可扩展性表明了当需要增加资源以执行更多工作时系统能够获得划算的等同提升( equal bang for the buck)的能力。 缺乏扩展能力的系统在达到收益递减的转折点后,将无法进一步增长。">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql08_扩展&amp;高可用">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;2019&#x2F;08&#x2F;22&#x2F;%E6%95%B0%E6%8D%AE%E5%BA%93&#x2F;mysql&#x2F;mysql08_%E6%89%A9%E5%B1%95&amp;%E9%AB%98%E5%8F%AF%E7%94%A8&#x2F;index.html">
<meta property="og:site_name" content="Chenaa&#39;s Notes">
<meta property="og:description" content="扩展mysql什么时候可扩展性？ 简要地说,可扩展性表明了当需要增加资源以执行更多工作时系统能够获得划算的等同提升( equal bang for the buck)的能力。 缺乏扩展能力的系统在达到收益递减的转折点后,将无法进一步增长。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_01.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_02.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_03.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_04.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_05.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_05.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;msyql_08_07.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_08.png">
<meta property="og:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;msyql_08_09.png">
<meta property="og:updated_time" content="2020-06-02T13:23:50.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;czh-pb-source.oss-cn-hongkong.aliyuncs.com&#x2F;pic&#x2F;mysql&#x2F;mysql_08_01.png">

<link rel="canonical" href="http://yoursite.com/2019/08/22/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql08_%E6%89%A9%E5%B1%95&%E9%AB%98%E5%8F%AF%E7%94%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>mysql08_扩展&高可用 | Chenaa's Notes</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Chenaa's Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">尘事如潮人如水</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/22/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql08_%E6%89%A9%E5%B1%95&%E9%AB%98%E5%8F%AF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="chenaa">
      <meta itemprop="description" content="zZ..zZ..">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Chenaa's Notes">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql08_扩展&高可用
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-22 20:30:00" itemprop="dateCreated datePublished" datetime="2019-08-22T20:30:00+08:00">2019-08-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-06-02 21:23:50" itemprop="dateModified" datetime="2020-06-02T21:23:50+08:00">2020-06-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="扩展mysql"><a href="#扩展mysql" class="headerlink" title="扩展mysql"></a>扩展mysql</h1><p><strong>什么时候可扩展性？</strong></p>
<p>简要地说,可扩展性表明了当需要增加资源以执行更多工作时系统能够获得划算的等同提升( equal bang for the buck)的能力。</p>
<p><strong>缺乏扩展能力的系统在达到收益递减的转折点后,将无法进一步增长。</strong></p>
<p> <img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_01.png" alt=""></p>
<a id="more"></a>


<h2 id="向上扩展"><a href="#向上扩展" class="headerlink" title="向上扩展"></a>向上扩展</h2><p><strong>向上扩展(有时也称为垂直扩展)意味着购买更多性能强悍的硬件</strong>,对很多应用来说这是唯一需要做的事情。</p>
<p>这种策略有很多好处。例如,单台服务器比多台服务器更加容易维护和开发,能显著节约开销。</p>
<p>在单台服务器上备份和恢复应用同样很简单,因为无须关心一致性或者哪个数据集是权威的。</p>
<p>从复杂性的成本来说,向上扩展比向外扩展更简单。</p>
<h2 id="向外扩展"><a href="#向外扩展" class="headerlink" title="向外扩展"></a>向外扩展</h2><p>可以把向外扩展(有时也称为横向扩展或者水平扩展)策略划分为三个部分:复制、拆分,以及数据分片( sharding)。</p>
<h3 id="主从读写分离"><a href="#主从读写分离" class="headerlink" title="主从读写分离"></a>主从读写分离</h3><p>主库写入数据，从库提供读服务或者跑大量统计任务。</p>
<h3 id="拆分"><a href="#拆分" class="headerlink" title="拆分"></a>拆分</h3><p><strong>按功能拆分(垂直分库)</strong></p>
<p>按系统的不同功能，进行数据库拆分，微服务化每个应用用自己单独的数据库。</p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_02.png" alt=""></p>
<p> <img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_03.png" alt=""></p>
<p> <strong>垂直拆分表</strong></p>
<p> 一般是表中的字段较多，将不常用的， 数据较大，长度较长（比如text类型字段）的拆分到“扩展表“。</p>
<h3 id="数据分片"><a href="#数据分片" class="headerlink" title="数据分片"></a>数据分片</h3><p>在目前用于扩展大型 MySQL应用的方案中,数据分片是最通用且最成功的方法。它把数据分割成一小片,或者说一块,然后存储到不同的节点中。</p>
<p>大多数分片系统也有一些“全局的”数据不会被分片(例如城市列表或者登录数据)。全局数据一般存储在单个节点上并且通常保存在类似redis这样的缓存里。</p>
<p>大多数应用只会对需要的数据做分片——通常是那些将会增长得非常庞大的数据。用户数达到5亿,那么就可能需要对用户数据分片。用户的定单数据，非常庞大,并且还会越来越多也需要做数据分片。</p>
<h3 id="切分策略"><a href="#切分策略" class="headerlink" title="切分策略"></a>切分策略</h3><h4 id="动态映射分配"><a href="#动态映射分配" class="headerlink" title="动态映射分配"></a>动态映射分配</h4><p>将ID和库的Mapping关系记录在一个单独的库中。</p>
<p>优点：ID和库的Mapping算法可以随意更改。<br>缺点：引入额外的单点。<br><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_04.png" alt=""></p>
<h4 id="范围切分"><a href="#范围切分" class="headerlink" title="范围切分"></a>范围切分</h4><p>range分片 : 比如按照时间区间或ID区间来切分。</p>
<p>优点：单表大小可控，天然水平扩展。<br>缺点：无法解决集中写入瓶颈的问题,存在的数据热点问题，热点会出现在最新的几台机器上。<br><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_05.png" alt=""></p>
<h4 id="hash分片"><a href="#hash分片" class="headerlink" title="hash分片"></a>hash分片</h4><p><strong>hash分片一定要做好容量规划，如果需要扩容，重新计算hash值代价非常大。可以先规划足够大的容量，比如一次性份1024个表，尽量避免再次扩容</strong></p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_05.png" alt=""></p>
<p><strong>刚开始可以一个数据库多个数据分片，随着业务量的上升，可以逐渐过渡到一个数据库一个分片。</strong></p>
<h3 id="唯一键方案"><a href="#唯一键方案" class="headerlink" title="唯一键方案"></a>唯一键方案</h3><p>这个方案也很多，主流的有那么几种:</p>
<h4 id="利用数据库自增ID"><a href="#利用数据库自增ID" class="headerlink" title="利用数据库自增ID"></a>利用数据库自增ID</h4><p>优点：最简单。<br>缺点：单点风险、单机性能瓶颈。</p>
<h4 id="利用数据库集群并设置相应的步长"><a href="#利用数据库集群并设置相应的步长" class="headerlink" title="利用数据库集群并设置相应的步长"></a>利用数据库集群并设置相应的步长</h4><p>优点：高可用、ID较简洁。<br>缺点：需要单独的数据库集群。</p>
<h4 id="Twitter-Snowflake"><a href="#Twitter-Snowflake" class="headerlink" title="Twitter Snowflake"></a>Twitter Snowflake</h4><p>优点：高性能高可用、易拓展。<br>缺点：需要独立的集群以及ZK。</p>
<h4 id="UUID-Random算法"><a href="#UUID-Random算法" class="headerlink" title="UUID/Random算法"></a>UUID/Random算法</h4><p>优点：简单。<br> 缺点：生成ID较长，有重复几率。</p>
<h4 id="根据业务-时间戳-业务编号"><a href="#根据业务-时间戳-业务编号" class="headerlink" title="根据业务 时间戳+业务编号"></a>根据业务 时间戳+业务编号</h4><p>结合自身业务，实现唯一键 如 时间戳+用户标识码+随机数</p>
<p>优点：简单，基本不会重复<br>缺点：长度稍长，性能要比int/bigint的稍差等。</p>
<h1 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h1><h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>主库写入数据，从库提供读服务或者跑大量统计任务。</p>
<h2 id="DNS负载均衡"><a href="#DNS负载均衡" class="headerlink" title="DNS负载均衡"></a>DNS负载均衡</h2><p>这是一个比较粗糙的负载均衡技术。</p>
<p>最简单的方法是只读服务器拥有一个DNS名,而给负责写操作的服务器起另外一个DNS名。如果备库能够跟上主库,那就把只读DNS名指定给备库,当出现延迟时,再将该DNS名指定给主库。</p>
<p>这种DNS技术非常容易实现,但也有很多缺点。最大的问题是无法完全控制DNS。</p>
<ul>
<li>修改DNS并不是立刻生效的,也不是原子的。将DNS的变化传递到整个网络或在网络间传播都需要比较长的时间。</li>
<li>DNS数据会在各个地方缓存下来,它的过期时间是建议性质的,而非强制的。</li>
<li>可能需要应用或服务器重启才能使修改后的DNS完全生效</li>
<li>多个IP地址共用一个DNS名并依赖于轮询行为来均衡请求,这并不是一个好主意。因为轮询行为并不总是可预知的。</li>
<li>DBA可能没有权限直接访问DNS。</li>
</ul>
<h2 id="转移IP地址-虚拟ip、LVS"><a href="#转移IP地址-虚拟ip、LVS" class="headerlink" title="转移IP地址(虚拟ip、LVS)"></a>转移IP地址(虚拟ip、LVS)</h2><p>些负载均衡解决方案依赖于在服务器间转移虚拟地址,一般能够很好地工作。</p>
<p>这听起来和修改DNS很像,但完全是两码事。</p>
<p>服务器不会根据DNS名去监听网络流量,而是根据指定的IP地址去监听流量,所以转移IP地址允许DNS名保持不变。</p>
<p>你可以通过ARP(地址解析协议)命令强制使IP地址的更改快速而且原子性地通知到网络上。</p>
<p><strong>一个比较方便的技术是为每个物理服务器分配一个固定的IP地址。该IP地址固定在服务器上,不再改变。然后可以为每个逻辑上的“服务”使用一个虚拟IP地址。</strong>它们能够很方便地在服务器间转移,这使得转移服务和应用实例无须再重新配置应用,因此更加容易。</p>
<h2 id="中间件负载均衡"><a href="#中间件负载均衡" class="headerlink" title="中间件负载均衡"></a>中间件负载均衡</h2><h3 id="负载均衡器"><a href="#负载均衡器" class="headerlink" title="负载均衡器"></a>负载均衡器</h3><p>在市场上有许多负载均衡硬件和软件,但很少有专门为 MySQL服务器设计的。web服务器通常更需要负载均衡,因此许多多用途的负载均衡设备都会支持HTTP,而对其他用途则只有一些很少的基本特性。</p>
<p> MySQL连接都只是正常的TCP/IP连接,所以可以在 MySQL上使用多用途负载均衡器。但由于缺少 MySQL专有的特性,因此会多一些限制。(HAProxy)</p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/msyql_08_07.png" alt=""></p>
<h3 id="常见负载均衡算法"><a href="#常见负载均衡算法" class="headerlink" title="常见负载均衡算法"></a>常见负载均衡算法</h3><ol>
<li><strong>随机</strong> 负载均衡器随机地从可用的服务器池中选择一个服务器来处理请求。</li>
<li><strong>轮询</strong> 负载均衡器以循环顺序发送请求到服务器,例如:A,B,C,A,B,C。</li>
<li><strong>最少连接数</strong> 下一个连接请求分配给拥有最少活跃连接的服务器。</li>
<li><strong>最快响应</strong> 能够最快处理请求的服务器接受下一个连接。</li>
<li><strong>哈希</strong> 负载均衡器通过连接的源IP地址进行哈希,将其映射到池中的同一个服务器上。每次从同一个IP地址发起请求,负载均衡器都会将请求发送给同样的服务器。只有当池中服务器数目改变时这种绑定才会发生变化。</li>
<li><strong>权重</strong> 负载均衡器能够结合使用上述几种算法。</li>
</ol>
<h1 id="MySql高可用-复制原理"><a href="#MySql高可用-复制原理" class="headerlink" title="MySql高可用(复制原理)"></a>MySql高可用(复制原理)</h1><h2 id="复制基本原理"><a href="#复制基本原理" class="headerlink" title="复制基本原理"></a>复制基本原理</h2><p>在详细介绍如何设置复制之前,让我们先看看 MySQL实际上是如何复制数据的。总的来说,复制有三个步骤:</p>
<ol>
<li><p>在主库上把数据更改记录到二进制日志( Binary Log)中(这些记录被称为二进制日志事件)。</p>
</li>
<li><p>备库将主库上的日志复制到自己的中继日志( Relay Log)中。</p>
</li>
<li><p>备库读取中继日志中的事件,将其重放到备库数据之上。</p>
<p><img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/mysql_08_08.png" alt=""></p>
<p><strong>IO线程是单线程的，SQL线程是可以多线程的</strong></p>
</li>
</ol>
<h2 id="binlog的三种格式"><a href="#binlog的三种格式" class="headerlink" title="binlog的三种格式"></a>binlog的三种格式</h2><h3 id="statement-基于语句的复制"><a href="#statement-基于语句的复制" class="headerlink" title="statement 基于语句的复制"></a>statement 基于语句的复制</h3><h3 id="row基于行的复制"><a href="#row基于行的复制" class="headerlink" title="row基于行的复制"></a>row基于行的复制</h3><h3 id="mixed混合复制"><a href="#mixed混合复制" class="headerlink" title="mixed混合复制"></a>mixed混合复制</h3><p>为什么会有mixed格式的binlog？</p>
<p>因为有些statement格式的binlog可能会导致主备不一致，所以要使用row格式。</p>
<p>但row格式的缺点是，很占空间。比如你用一个delete语句删掉10万行数据，用statement的话就是一个SQL语句被记录到binlog中，占用几十个字节的空间。但如果用row格式的binlog，就要把这10万条记录都写到binlog中。这样做，不仅会占用更大的空间，同时写binlog也要耗费IO资源，影响执行速度。</p>
<p>所以，MySQL就取了个折中方案，也就是有了mixed格式的binlog。mixed格式的意思是，MySQL自己会判断这条SQL语句是否可能引起主备不一致，如果有可能，就用row格式，否则就用statement格式。</p>
<h2 id="复制过滤器"><a href="#复制过滤器" class="headerlink" title="复制过滤器"></a>复制过滤器</h2><p> <img src="https://czh-pb-source.oss-cn-hongkong.aliyuncs.com/pic/mysql/msyql_08_09.png" alt=""></p>
<p>使用选项 binlog_do_db和 binlog_ ignore_db来控制过滤被复制端的输出。一般不启用这两个参数，只控制从库过滤。</p>
<h2 id="常见的部署架构"><a href="#常见的部署架构" class="headerlink" title="常见的部署架构"></a>常见的部署架构</h2><h3 id="主从"><a href="#主从" class="headerlink" title="主从"></a>主从</h3><p>最简单的</p>
<h3 id="主主"><a href="#主主" class="headerlink" title="主主"></a>主主</h3><p>自增id设定步长和起始位置，来保证不冲突，实现主主复制</p>
<h3 id="循环复制问题"><a href="#循环复制问题" class="headerlink" title="循环复制问题"></a>循环复制问题</h3><p>业务逻辑在节点A上更新了一条语句，然后再把生成的binlog 发给节点B，节点B执行完这条更新语句后也会生成binlog。（我建议你把参数log_slave_updates设置为on，表示备库执行relay log后生成binlog）。</p>
<p>那么，如果节点A同时是节点B的备库，相当于又把节点B新生成的binlog拿过来执行了一次，然后节点A和B间，会不断地循环执行这个更新语句，也就是循环复制了。这个要怎么解决呢？</p>
<p><strong>当复制SQL线程读中继日志时,会丢弃事件中记录的服务器ID和该服务<br>器本身ID相同的事件,从而打破了复制过程中的无限循环。</strong>在某些复制拓扑结构下打破无限循环非常重要,例如主-主复制。</p>
<h2 id="主从延迟来源"><a href="#主从延迟来源" class="headerlink" title="主从延迟来源"></a>主从延迟来源</h2><ol>
<li>从库性能比较差</li>
<li>备库的压力大 一般可以这么处理：一主多从。除了备库外，可以多接几个从库，让这些从库来分担读的压力。</li>
<li>大事务 一次删除大量数据或者大表DDL</li>
</ol>
<h2 id="复制的方式"><a href="#复制的方式" class="headerlink" title="复制的方式"></a>复制的方式</h2><h3 id="异步复制"><a href="#异步复制" class="headerlink" title="异步复制"></a>异步复制</h3><p>默认的复制方式，存在数据丢失的可能性</p>
<h3 id="半同步复制-防止脑裂"><a href="#半同步复制-防止脑裂" class="headerlink" title="半同步复制(防止脑裂)"></a>半同步复制(防止脑裂)</h3><p>为了解决默认复制方式，存在数据丢失的问题，引入半同步复制，也就是<strong>semi-sync replication</strong></p>
<p>semi-sync做了这样的设计：</p>
<ol>
<li>事务提交的时候，主库把binlog发给从库；</li>
<li>从库收到binlog以后，发回给主库一个ack，表示收到了；</li>
<li>主库收到这个ack以后，才能给客户端返回“事务完成”的确认。</li>
</ol>
<p>也就是说，如果启用了semi-sync，就表示所有给客户端发送过确认的事务，都确保了备库已经收到了这个日志。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/08/21/%E6%95%B0%E6%8D%AE%E5%BA%93/mysql/mysql07_mysql%E4%BC%98%E5%8C%96/" rel="prev" title="mysql07_mysql优化">
      <i class="fa fa-chevron-left"></i> mysql07_mysql优化
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/09/01/jvm/jvm01_jvm%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" rel="next" title="jvm01_jvm内存结构">
      jvm01_jvm内存结构 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#扩展mysql"><span class="nav-number">1.</span> <span class="nav-text">扩展mysql</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#向上扩展"><span class="nav-number">1.1.</span> <span class="nav-text">向上扩展</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#向外扩展"><span class="nav-number">1.2.</span> <span class="nav-text">向外扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主从读写分离"><span class="nav-number">1.2.1.</span> <span class="nav-text">主从读写分离</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拆分"><span class="nav-number">1.2.2.</span> <span class="nav-text">拆分</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据分片"><span class="nav-number">1.2.3.</span> <span class="nav-text">数据分片</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#切分策略"><span class="nav-number">1.2.4.</span> <span class="nav-text">切分策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#动态映射分配"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">动态映射分配</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#范围切分"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">范围切分</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hash分片"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">hash分片</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#唯一键方案"><span class="nav-number">1.2.5.</span> <span class="nav-text">唯一键方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#利用数据库自增ID"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">利用数据库自增ID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#利用数据库集群并设置相应的步长"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">利用数据库集群并设置相应的步长</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Twitter-Snowflake"><span class="nav-number">1.2.5.3.</span> <span class="nav-text">Twitter Snowflake</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UUID-Random算法"><span class="nav-number">1.2.5.4.</span> <span class="nav-text">UUID/Random算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#根据业务-时间戳-业务编号"><span class="nav-number">1.2.5.5.</span> <span class="nav-text">根据业务 时间戳+业务编号</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#负载均衡"><span class="nav-number">2.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#读写分离"><span class="nav-number">2.1.</span> <span class="nav-text">读写分离</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS负载均衡"><span class="nav-number">2.2.</span> <span class="nav-text">DNS负载均衡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#转移IP地址-虚拟ip、LVS"><span class="nav-number">2.3.</span> <span class="nav-text">转移IP地址(虚拟ip、LVS)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间件负载均衡"><span class="nav-number">2.4.</span> <span class="nav-text">中间件负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡器"><span class="nav-number">2.4.1.</span> <span class="nav-text">负载均衡器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见负载均衡算法"><span class="nav-number">2.4.2.</span> <span class="nav-text">常见负载均衡算法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MySql高可用-复制原理"><span class="nav-number">3.</span> <span class="nav-text">MySql高可用(复制原理)</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#复制基本原理"><span class="nav-number">3.1.</span> <span class="nav-text">复制基本原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#binlog的三种格式"><span class="nav-number">3.2.</span> <span class="nav-text">binlog的三种格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#statement-基于语句的复制"><span class="nav-number">3.2.1.</span> <span class="nav-text">statement 基于语句的复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#row基于行的复制"><span class="nav-number">3.2.2.</span> <span class="nav-text">row基于行的复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mixed混合复制"><span class="nav-number">3.2.3.</span> <span class="nav-text">mixed混合复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复制过滤器"><span class="nav-number">3.3.</span> <span class="nav-text">复制过滤器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见的部署架构"><span class="nav-number">3.4.</span> <span class="nav-text">常见的部署架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主从"><span class="nav-number">3.4.1.</span> <span class="nav-text">主从</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主主"><span class="nav-number">3.4.2.</span> <span class="nav-text">主主</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#循环复制问题"><span class="nav-number">3.4.3.</span> <span class="nav-text">循环复制问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主从延迟来源"><span class="nav-number">3.5.</span> <span class="nav-text">主从延迟来源</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复制的方式"><span class="nav-number">3.6.</span> <span class="nav-text">复制的方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异步复制"><span class="nav-number">3.6.1.</span> <span class="nav-text">异步复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#半同步复制-防止脑裂"><span class="nav-number">3.6.2.</span> <span class="nav-text">半同步复制(防止脑裂)</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="chenaa"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">chenaa</p>
  <div class="site-description" itemprop="description">zZ..zZ..</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">44</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenaa</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.1
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
